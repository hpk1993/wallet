// worker.js (برای پیست در Quick Edit داشبورد Cloudflare Workers)
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

const USDT_ADDRESS = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t'; // USDT TRC20 (Tron mainnet)
const USDT_ABI = [
  {
    "constant": false,
    "inputs": [
      { "name": "_to", "type": "address" },
      { "name": "_value", "type": "uint256" }
    ],
    "name": "transfer",
    "outputs": [{ "name": "success", "type": "bool" }],
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [{ "name": "_owner", "type": "address" }],
    "name": "balanceOf",
    "outputs": [{ "name": "balance", "type": "uint256" }],
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "decimals",
    "outputs": [{ "name": "", "type": "uint8" }],
    "type": "function"
  }
];
const TRON_NODE = 'https://api.trongrid.io'; // نود عمومی Tron

// صفحه HTML برای فرم ورودی
const htmlForm = `
<!DOCTYPE html>
<html>
<head>
  <title>انتقال USDT (TRC20)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 600px; margin: auto; }
    input, button { padding: 10px; margin: 5px; width: 100%; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    #result { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>انتقال USDT (TRC20) در شبکه Tron</h2>
    <form id="transferForm">
      <label>Seed Phrase (۱۲ کلمه):</label><br>
      <input type="text" id="seedPhrase" required placeholder="word1 word2 ... word12"><br>
      <label>آدرس مقصد (TRC20):</label><br>
      <input type="text" id="toAddress" required placeholder="Txxxxxxxxxxxxxxxxxxxxxxxxxxxx"><br>
      <label>مقدار USDT:</label><br>
      <input type="number" id="amountUsdt" value="100" step="0.000001" required><br>
      <button type="submit">ارسال</button>
    </form>
    <div id="result"></div>
  </div>
  <script>
    async function sendRequest(seedPhrase, toAddress, amountUsdt) {
      const response = await fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ seedPhrase, toAddress, amountUsdt })
      });
      const result = await response.json();
      document.getElementById('result').innerText = JSON.stringify(result, null, 2);
    }

    document.getElementById('transferForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const seedPhrase = document.getElementById('seedPhrase').value;
      const toAddress = document.getElementById('toAddress').value;
      const amountUsdt = document.getElementById('amountUsdt').value;
      document.getElementById('result').innerText = 'در حال پردازش...';
      await sendRequest(seedPhrase, toAddress, amountUsdt);
    });
  </script>
</body>
</html>
`;

async function handleRequest(request) {
  if (request.method === 'GET') {
    // نمایش فرم HTML
    return new Response(htmlForm, {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  if (request.method !== 'POST') {
    return new Response('فقط POST مجاز است', { status: 405 });
  }

  try {
    // لود tronweb از CDN
    const TronWeb = (await import('https://unpkg.com/tronweb@5.3.3/dist/tronweb.min.js')).default;

    const body = await request.json();
    const { seedPhrase, toAddress, amountUsdt = '100' } = body;

    if (!seedPhrase || !toAddress) {
      return new Response(JSON.stringify({ error: 'seedPhrase و toAddress الزامی است' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // مقداردهی TronWeb
    const tronWeb = new TronWeb({
      fullHost: TRON_NODE
    });

    // Recover wallet از seed phrase
    const wallet = await tronWeb.fromMnemonic(seedPhrase);
    tronWeb.setPrivateKey(wallet.privateKey);

    // چک موجودی TRX برای gas
    const balanceTRX = await tronWeb.trx.getBalance(wallet.address);
    if (balanceTRX < 1_000_000) { // حداقل 1 TRX برای gas
      return new Response(JSON.stringify({ error: 'موجودی TRX برای gas کافی نیست' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // چک موجودی USDT
    const usdtContract = await tronWeb.contract(USDT_ABI, USDT_ADDRESS);
    const decimals = await usdtContract.decimals().call(); // 6 برای USDT
    const balance = await usdtContract.balanceOf(wallet.address).call();
    const balanceUsdt = Number(balance) / 10 ** decimals;

    if (balanceUsdt < parseFloat(amountUsdt)) {
      return new Response(JSON.stringify({ error: `موجودی کافی نیست. موجودی فعلی: ${balanceUsdt} USDT` }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // انتقال USDT
    const amountSun = parseFloat(amountUsdt) * 10 ** decimals;
    const tx = await usdtContract.transfer(toAddress, amountSun).send();
    const receipt = await tronWeb.trx.getTransactionInfo(tx);
    while (!receipt) {
      await new Promise(resolve => setTimeout(resolve, 1000)); // منتظر تأیید
      receipt = await tronWeb.trx.getTransactionInfo(tx);
    }

    return new Response(JSON.stringify({
      success: true,
      txHash: tx,
      message: `${amountUsdt} USDT به ${toAddress} ارسال شد`
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });

  } catch (error) {
    return new Response(JSON.stringify({ error: `خطا: ${error.message}` }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}
